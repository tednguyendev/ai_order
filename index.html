<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Order</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body { height: 100%; }
  body { font-family: 'Inter', sans-serif; background: #18181b; color: #d4d4d8; padding: 32px; min-height: 100vh; display: flex; flex-direction: column; }

  /* Header */
  .header { text-align: center; margin-bottom: 24px; }
  .header h1 { font-size: 20px; font-weight: 600; color: #fafafa; letter-spacing: -0.3px; }
  .header .subtitle { color: #52525b; font-size: 13px; margin-top: 4px; font-weight: 400; }

  /* Tabs */
  .tabs { display: flex; gap: 4px; margin-bottom: 0; }
  .tab {
    padding: 10px 20px; cursor: pointer; font-family: inherit; font-size: 12px; font-weight: 500;
    border: 1px solid #27272a; border-bottom: none; background: #27272a; color: #71717a;
    border-radius: 10px 10px 0 0; position: relative; top: 1px; transition: all 0.15s;
  }
  .tab.active { background: #d4d4d8; color: #18181b; font-weight: 600; z-index: 1; border-color: #d4d4d8; }
  .tab:not(.active):hover { background: #3f3f46; color: #a1a1aa; }

  /* Main container */
  .container {
    border: 1px solid #3f3f46; background: #27272a; border-radius: 0 12px 12px 12px;
    flex: 1; display: flex; gap: 0; min-height: 0;
  }

  /* Left panel — code/data display */
  .left-panel {
    width: 260px; border-right: 1px solid #3f3f46; padding: 16px;
    flex-shrink: 0; background: #1f1f23; overflow-y: auto;
    pointer-events: none; user-select: none;
  }
  .panel-title {
    font-size: 9px; font-weight: 600; text-transform: uppercase;
    color: #a1a1aa; letter-spacing: 1.2px; margin-bottom: 12px;
    border-bottom: 1px solid #3f3f46; padding-bottom: 8px;
  }
  .data-block {
    font-family: 'IBM Plex Mono', monospace; font-size: 10px;
    color: #71717a; line-height: 1.9; background: #27272a;
    border-radius: 8px; padding: 12px; border: 1px solid #3f3f46;
  }
  .data-block .data-item { margin-bottom: 8px; }
  .data-block .data-item:last-child { margin-bottom: 0; }
  .data-block .data-name { color: #a1a1aa; }
  .data-block .data-price { color: #52525b; }
  .data-block .data-opt { padding-left: 14px; color: #a1a1aa; }
  .data-block .data-opt .data-vals { color: #d4d4d8; }

  /* Chat area */
  .chat-area { flex: 1; display: flex; flex-direction: column; background: #27272a; }
  .chat-header {
    font-size: 9px; font-weight: 600; text-transform: uppercase;
    color: #a1a1aa; letter-spacing: 1.2px; padding: 16px 16px 8px;
    border-bottom: 1px solid #3f3f46;
  }
  .messages { flex: 1; padding: 14px 16px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
  .msg {
    padding: 10px 14px; border-radius: 12px;
    font-size: 12px; max-width: 80%; line-height: 1.6;
  }
  .msg.user { background: #52525b; color: #fafafa; align-self: flex-end; }
  .msg.bot { background: #3f3f46; color: #d4d4d8; align-self: flex-start; }
  .msg .label { font-size: 9px; color: #71717a; margin-bottom: 3px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
  .msg.user .label { color: #a1a1aa; }

  /* Input */
  .chat-input {
    border-top: 1px solid #3f3f46; padding: 12px; display: flex; gap: 8px;
  }
  .chat-input input {
    flex: 1; padding: 10px 14px; border: none; border-radius: 8px;
    font-family: inherit; font-size: 12px; background: #3f3f46; color: #e4e4e7;
    outline: none;
  }
  .chat-input input::placeholder { color: #52525b; }
  .chat-input button {
    padding: 10px 18px; border: none; background: #d4d4d8;
    color: #18181b; font-family: inherit; font-size: 12px; font-weight: 600;
    border-radius: 8px; cursor: pointer; transition: background 0.15s;
  }
  .chat-input button:hover { background: #e4e4e7; }
  .chat-input button:disabled { opacity: 0.4; cursor: not-allowed; }

  /* Right panel */
  .right-panel {
    width: 260px; border-left: 1px solid #3f3f46; padding: 16px;
    flex-shrink: 0; background: #27272a; overflow-y: auto;
    display: flex; flex-direction: column;
  }

  /* Order output */
  .order-box {
    border-radius: 8px; padding: 12px;
    font-size: 11px; line-height: 1.4; background: #3f3f46; color: #d4d4d8;
  }
  .order-box .order-title { font-weight: 700; font-size: 12px; color: #fafafa; margin-bottom: 6px; border-bottom: 1px solid #52525b; padding-bottom: 6px; }
  .order-line { display: flex; justify-content: space-between; }
  .order-line .detail { color: #a1a1aa; font-size: 10px; padding-left: 12px; }
  .order-opts { padding-left: 12px; font-family: 'IBM Plex Mono', monospace; font-size: 9px; line-height: 1.8; }
  .order-opts .opt-key { color: #a1a1aa; }
  .order-opts .opt-val { color: #d4d4d8; }
  .order-total { border-top: 1px solid #52525b; margin-top: 6px; padding-top: 6px; font-weight: 700; display: flex; justify-content: space-between; color: #fafafa; }
  .order-status {
    margin-top: 12px; padding: 8px; background: #d4d4d8; color: #18181b;
    border-radius: 8px; font-size: 12px; text-align: center; font-weight: 600;
    cursor: pointer; border: none; width: 100%; transition: background 0.15s;
  }
  .order-status:hover { background: #e4e4e7; }
  .order-status.clicked { background: #4ade80; color: #052e16; }

  /* Toast */
  .toast {
    position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(80px);
    background: #d4d4d8; color: #18181b; padding: 10px 24px; border-radius: 8px;
    font-size: 12px; font-weight: 500; opacity: 0; transition: all 0.3s; z-index: 100;
    pointer-events: none;
  }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  /* Typing indicator */
  .msg.typing .dots span {
    display: inline-block; width: 6px; height: 6px; border-radius: 50%;
    background: #52525b; margin: 0 2px; animation: blink 1.2s infinite;
  }
  .msg.typing .dots span:nth-child(2) { animation-delay: 0.2s; }
  .msg.typing .dots span:nth-child(3) { animation-delay: 0.4s; }
  @keyframes blink { 0%, 60%, 100% { opacity: 0.3; } 30% { opacity: 1; } }


  .hidden { display: none; }

  /* Annotation */
  .annotation {
    font-size: 10px; color: #3f3f46; font-style: italic;
    margin-top: 10px; padding: 4px 6px; border-left: 2px solid #3f3f46;
  }

  .flow-arrow { text-align: center; color: #3f3f46; font-size: 16px; padding: 8px 0; }
</style>
</head>
<body>

<div class="header">
  <h1>AI Order</h1>
  <p class="subtitle">WhatsApp Food Ordering Bot</p>
</div>

<!-- Tabs -->
<div class="tabs">
  <div class="tab active" onclick="showTab('place')">Place Order</div>
  <div class="tab" onclick="showTab('edit')">Edit Order</div>
</div>

<!-- TAB 1: Place Order -->
<div class="container" id="tab-place">
  <!-- Left: Menu (data display) -->
  <div class="left-panel">
    <div class="panel-title">Menu Items</div>
    <div class="data-block">
      <div class="data-item">
        <span class="data-name">Brown Sugar Boba</span> <span class="data-price">$4.50</span>
        <div class="data-opt">sugar: <span class="data-vals">0% | 25% | 50% | 75% | 100%</span></div>
        <div class="data-opt">ice: <span class="data-vals">none | less | normal</span></div>
        <div class="data-opt">toppings +$0.50: <span class="data-vals">pearl | jelly | pudding</span></div>
      </div>
      <div class="data-item">
        <span class="data-name">Teh C</span> <span class="data-price">$3.80</span>
        <div class="data-opt">sugar: <span class="data-vals">kosong | siu dai | normal</span></div>
        <div class="data-opt">temp: <span class="data-vals">hot | cold</span></div>
      </div>
      <div class="data-item">
        <span class="data-name">Nasi Lemak</span> <span class="data-price">$5.50</span>
        <div class="data-opt">spice: <span class="data-vals">mild | normal | extra</span></div>
        <div class="data-opt">add-on +$0.50: <span class="data-vals">egg | otah | chicken</span></div>
      </div>
      <div class="data-item">
        <span class="data-name">Kopi Gao</span> <span class="data-price">$4.00</span>
        <div class="data-opt">sugar: <span class="data-vals">kosong | normal | gah dai</span></div>
        <div class="data-opt">temp: <span class="data-vals">hot | cold</span></div>
      </div>
    </div>

  </div>

  <!-- Center: Chat -->
  <div class="chat-area">
    <div class="chat-header">Chat</div>
    <div class="messages">
      <div class="msg bot">Hi! What would you like to order today? You can see our menu on the left.</div>
    </div>
    <div class="chat-input">
      <input type="text" placeholder="Type your order in natural language...">
      <button>Send</button>
    </div>

  </div>

  <!-- Right: Order -->
  <div class="right-panel">
    <div class="panel-title">Order</div>
    <div id="place-order-box" class="order-box" style="color:#52525b; text-align:center; padding:24px 12px;">
      Your order will appear here
    </div>
  </div>
</div>

<!-- TAB 2: Edit Order -->
<div class="container hidden" id="tab-edit">
  <!-- Left: Menu (data display) -->
  <div class="left-panel">
    <div class="panel-title">Menu Items</div>
    <div class="data-block">
      <div class="data-item">
        <span class="data-name">Brown Sugar Boba</span> <span class="data-price">$4.50</span>
        <div class="data-opt">sugar: <span class="data-vals">0% | 25% | 50% | 75% | 100%</span></div>
        <div class="data-opt">ice: <span class="data-vals">none | less | normal</span></div>
        <div class="data-opt">toppings +$0.50: <span class="data-vals">pearl | jelly | pudding</span></div>
      </div>
      <div class="data-item">
        <span class="data-name">Teh C</span> <span class="data-price">$3.80</span>
        <div class="data-opt">sugar: <span class="data-vals">kosong | siu dai | normal</span></div>
        <div class="data-opt">temp: <span class="data-vals">hot | cold</span></div>
      </div>
      <div class="data-item">
        <span class="data-name">Nasi Lemak</span> <span class="data-price">$5.50</span>
        <div class="data-opt">spice: <span class="data-vals">mild | normal | extra</span></div>
        <div class="data-opt">add-on +$0.50: <span class="data-vals">egg | otah | chicken</span></div>
      </div>
      <div class="data-item">
        <span class="data-name">Kopi Gao</span> <span class="data-price">$4.00</span>
        <div class="data-opt">sugar: <span class="data-vals">kosong | normal | gah dai</span></div>
        <div class="data-opt">temp: <span class="data-vals">hot | cold</span></div>
      </div>
    </div>
  </div>

  <!-- Center: Chat -->
  <div class="chat-area">
    <div class="chat-header">Chat</div>
    <div class="messages">
      <div class="msg bot">Hi! I can see your order #0587. What would you like to change?</div>
    </div>
    <div class="chat-input">
      <input type="text" placeholder="Tell me what to change...">
      <button>Send</button>
    </div>
  </div>

  <!-- Right: Before & After -->
  <div class="right-panel">
    <div class="panel-title">Order</div>
    <div id="edit-order-box" class="order-box">
      <div class="order-title">#0587</div>
      <div class="order-line"><span>1x Brown Sugar Boba</span><span>$5.00</span></div>
      <div class="order-opts">
        <div><span class="opt-key">sugar:</span> <span class="opt-val">50%</span></div>
        <div><span class="opt-key">ice:</span> <span class="opt-val">none</span></div>
        <div><span class="opt-key">topping:</span> <span class="opt-val">pearl (+$0.50)</span></div>
      </div>
      <div style="height:4px;"></div>
      <div class="order-line"><span>1x Nasi Lemak</span><span>$6.00</span></div>
      <div class="order-opts">
        <div><span class="opt-key">spice:</span> <span class="opt-val">extra</span></div>
        <div><span class="opt-key">add-on:</span> <span class="opt-val">egg (+$0.50)</span></div>
      </div>
      <div style="height:4px;"></div>
      <div class="order-line"><span>2x Teh C</span><span>$7.60</span></div>
      <div class="order-opts">
        <div><span class="opt-key">sugar:</span> <span class="opt-val">siu dai</span></div>
        <div><span class="opt-key">temp:</span> <span class="opt-val">cold</span></div>
      </div>
      <div class="order-total"><span>TOTAL</span><span>$18.60</span></div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ── OpenAI config ──
const OPENAI_API_KEY = new URLSearchParams(window.location.hash.slice(1)).get('key') || '';

const SYSTEM_PROMPT = `You are a friendly WhatsApp food ordering bot for a hawker stall.

MENU:
1. Brown Sugar Boba — $4.50
   - sugar: 0%, 25%, 50%, 75%, 100%
   - ice: none, less, normal
   - toppings (+$0.50 each): pearl, jelly, pudding

2. Teh C — $3.80
   - sugar: kosong, siu dai, normal
   - temp: hot, cold

3. Nasi Lemak — $5.50
   - spice: mild, normal, extra
   - add-on (+$0.50 each): egg, otah, chicken

4. Kopi Gao — $4.00
   - sugar: kosong, normal, gah dai
   - temp: hot, cold

RULES:
- Understand Singlish and casual language.
- If the user's order is unclear or missing options, ask for clarification.
- After confirming an order, summarise it clearly with item names, options chosen, and total price.
- Be concise and friendly. Use short replies.
- If the user asks for something not on the menu, politely say it's not available.
- For the Edit Order flow, you are modifying an existing order. Confirm what changed.
- ACCUMULATE ORDERS: In Place Order mode, the order builds up across messages. Always include ALL current items in the "order" JSON. When the user adds items, include previous items plus new ones. When the user removes items, drop them from the list. When the user changes options, update that item.

OUTPUT FORMAT:
Always respond with a JSON object. Never respond with plain text.
{
  "message": "Your chat message to the customer",
  "order": null or { "items": [...], "total": number }
}

When "order" is null: you are greeting, asking a clarification question, or no order is ready yet.
When "order" is present, include all items with this structure:
{
  "name": "Item Name",
  "qty": 1,
  "price": 4.50,
  "options": { "sugar": "50%", "ice": "none" },
  "removed": false
}
Set "removed": true for items the customer asked to remove (edit mode).

PRICING — be precise:
- "price" for each item = base price + (number of add-ons/toppings × $0.50), multiplied by qty.
  Example: 1x Nasi Lemak with egg and chicken = $5.50 + $0.50 + $0.50 = $6.50
  Example: 1x Brown Sugar Boba with pearl = $4.50 + $0.50 = $5.00
  Example: 2x Teh C (no add-ons) = $3.80 × 2 = $7.60
- "total" = sum of all non-removed item prices.
Always include "order" when the customer has placed or confirmed items.`;

// Conversation history per tab
const conversationHistory = {
  place: [
    { role: 'system', content: SYSTEM_PROMPT },
    { role: 'assistant', content: "Hi! What would you like to order today? You can see our menu on the left." }
  ],
  edit: [
    { role: 'system', content: SYSTEM_PROMPT + '\n\nYou are now in Edit Order mode. The customer has existing order #0587:\n- 1x Brown Sugar Boba (sugar: 50%, ice: none, topping: pearl)\n- 1x Nasi Lemak (spice: extra, add-on: egg)\n- 2x Teh C (sugar: siu dai, temp: cold)\nTotal: $18.60\n\nHelp them modify this order.' },
    { role: 'assistant', content: "Hi! I can see your order #0587. What would you like to change?" }
  ]
};

async function callChatGPT(tabKey, userMessage) {
  conversationHistory[tabKey].push({ role: 'user', content: userMessage });

  const res = await fetch('https://api.openai.com/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${OPENAI_API_KEY}`
    },
    body: JSON.stringify({
      model: 'gpt-4o-mini',
      messages: conversationHistory[tabKey],
      temperature: 0.7,
      max_tokens: 500,
      response_format: { type: 'json_object' }
    })
  });

  if (!res.ok) {
    const err = await res.text();
    throw new Error(`OpenAI API error: ${res.status} — ${err}`);
  }

  const data = await res.json();
  const reply = data.choices[0].message.content;
  conversationHistory[tabKey].push({ role: 'assistant', content: reply });
  return reply;
}

function showTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('tab-place').classList.add('hidden');
  document.getElementById('tab-edit').classList.add('hidden');
  if (tab === 'place') {
    document.querySelectorAll('.tab')[0].classList.add('active');
    document.getElementById('tab-place').classList.remove('hidden');
  } else {
    document.querySelectorAll('.tab')[1].classList.add('active');
    document.getElementById('tab-edit').classList.remove('hidden');
  }
}

// Toast
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 1800);
}

async function sendMessage(container) {
  const input = container.querySelector('.chat-input input');
  const messages = container.querySelector('.messages');
  const text = input.value.trim();
  if (!text) return;

  // Determine which tab we're in
  const tabKey = container.id === 'tab-place' ? 'place' : 'edit';

  // Disable send while AI responds
  const sendBtn = container.querySelector('.chat-input button');
  sendBtn.disabled = true;

  // Add user message
  const userMsg = document.createElement('div');
  userMsg.className = 'msg user';
  userMsg.textContent = text;
  messages.appendChild(userMsg);
  input.value = '';
  messages.scrollTop = messages.scrollHeight;

  // Show typing indicator
  const typing = document.createElement('div');
  typing.className = 'msg bot typing';
  typing.innerHTML = '<div class="dots"><span></span><span></span><span></span></div>';
  messages.appendChild(typing);
  messages.scrollTop = messages.scrollHeight;

  // Call ChatGPT
  try {
    const reply = await callChatGPT(tabKey, text);
    typing.remove();

    let chatText = reply;
    let order = null;
    try {
      const parsed = JSON.parse(reply);
      chatText = parsed.message || reply;
      order = parsed.order || null;
    } catch (e) {
      // If JSON parse fails, use raw reply as chat text
    }

    const botMsg = document.createElement('div');
    botMsg.className = 'msg bot';
    botMsg.innerHTML = chatText.replace(/\n/g, '<br>');
    messages.appendChild(botMsg);

    if (order) {
      const boxId = tabKey === 'place' ? 'place-order-box' : 'edit-order-box';
      renderOrder(document.getElementById(boxId), order, tabKey);
    }
  } catch (err) {
    typing.remove();
    const errMsg = document.createElement('div');
    errMsg.className = 'msg bot';
    errMsg.textContent = 'Sorry, something went wrong. ' + err.message;
    messages.appendChild(errMsg);
  }
  // Re-enable send
  sendBtn.disabled = false;
  messages.scrollTop = messages.scrollHeight;
}

function renderOrder(box, order, tabKey) {
  // If no items (or all removed in place mode), show placeholder
  const hasItems = tabKey === 'place'
    ? order.items.some(i => !i.removed)
    : order.items.length > 0;

  if (!hasItems) {
    box.innerHTML = tabKey === 'place' ? 'Your order will appear here' : 'Your edited order will appear here';
    box.style.cssText = 'color:#52525b; text-align:center; padding:24px 12px;';
    const btn = box.parentElement.querySelector('.order-status');
    if (btn) btn.remove();
    return;
  }

  const orderNum = tabKey === 'edit' ? '#0587 (edited)' : '#' + String(Math.floor(1000 + Math.random() * 9000));
  let html = `<div class="order-title">${orderNum}</div>`;

  // In place mode, skip removed items entirely. In edit mode, show with strikethrough.
  const visibleItems = tabKey === 'place' ? order.items.filter(i => !i.removed) : order.items;

  visibleItems.forEach((item, idx) => {
    const strikeStyle = item.removed ? ' style="text-decoration: line-through; color: #52525b;"' : '';
    html += `<div class="order-line"${strikeStyle}><span>${item.qty}x ${item.name}</span><span>$${item.price.toFixed(2)}</span></div>`;

    if (item.options && !item.removed) {
      html += '<div class="order-opts">';
      for (const [key, val] of Object.entries(item.options)) {
        html += `<div><span class="opt-key">${key}:</span> <span class="opt-val">${val}</span></div>`;
      }
      html += '</div>';
    }
    if (idx < visibleItems.length - 1) html += '<div style="height:4px;"></div>';
  });

  // Compute total from items (don't trust GPT math)
  const computedTotal = order.items
    .filter(i => !i.removed)
    .reduce((sum, i) => sum + i.price, 0);
  html += `<div class="order-total"><span>TOTAL</span><span>$${computedTotal.toFixed(2)}</span></div>`;
  box.innerHTML = html;
  box.style = '';

  // Add submit button after the order box if not already there
  let submitBtn = box.parentElement.querySelector('.order-status');
  if (!submitBtn) {
    submitBtn = document.createElement('button');
    submitBtn.className = 'order-status';
    submitBtn.textContent = 'Submit';
    box.parentElement.appendChild(submitBtn);
    submitBtn.addEventListener('click', () => {
      const label = submitBtn.textContent;
      submitBtn.classList.add('clicked');
      submitBtn.textContent = 'Sent!';
      showToast('Order submitted successfully');
      setTimeout(() => { submitBtn.classList.remove('clicked'); submitBtn.textContent = label; }, 2000);
    });
  }
}

// Send button clicks
document.querySelectorAll('.chat-input button').forEach(btn => {
  btn.addEventListener('click', () => sendMessage(btn.closest('.container')));
});

// Enter key
document.querySelectorAll('.chat-input input').forEach(input => {
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter') sendMessage(input.closest('.container'));
  });
});

// Order buttons
document.querySelectorAll('.order-status').forEach(btn => {
  btn.addEventListener('click', () => {
    const label = btn.textContent;
    btn.classList.add('clicked');
    btn.textContent = 'Sent!';
    showToast('Order submitted successfully');
    setTimeout(() => {
      btn.classList.remove('clicked');
      btn.textContent = label;
    }, 2000);
  });
});
</script>

</body>
</html>
