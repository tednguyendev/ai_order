<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Order - Sketch</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Courier New', monospace; background: #f5f5f0; color: #333; padding: 32px; }
  h1 { text-align: center; font-size: 20px; margin-bottom: 8px; }
  .subtitle { text-align: center; color: #888; font-size: 13px; margin-bottom: 24px; }

  /* Tabs */
  .tabs { display: flex; gap: 0; margin-bottom: 0; }
  .tab {
    padding: 10px 24px; cursor: pointer; font-family: inherit; font-size: 14px;
    border: 2px solid #333; border-bottom: none; background: #e8e8e0;
    border-radius: 8px 8px 0 0; position: relative; top: 2px;
  }
  .tab.active { background: #fff; font-weight: bold; z-index: 1; }
  .tab:not(.active):hover { background: #ddd; }

  /* Main container */
  .container {
    border: 2px solid #333; background: #fff; border-radius: 0 8px 8px 8px;
    min-height: 520px; display: flex; gap: 0;
  }

  /* Left panel - menu / existing order */
  .left-panel {
    width: 260px; border-right: 2px dashed #ccc; padding: 16px;
    flex-shrink: 0;
  }
  .panel-title {
    font-size: 12px; font-weight: bold; text-transform: uppercase;
    color: #888; letter-spacing: 1px; margin-bottom: 12px;
    border-bottom: 1px solid #ddd; padding-bottom: 6px;
  }

  /* Menu items */
  .menu-item {
    padding: 8px; margin-bottom: 6px; border: 1px dashed #bbb;
    border-radius: 4px; font-size: 12px; background: #fafaf5;
  }
  .menu-item .name { font-weight: bold; }
  .menu-item .options { margin-top: 6px; }
  .menu-item .option-group { margin-bottom: 4px; }
  .menu-item .option-label { font-size: 10px; color: #999; text-transform: uppercase; letter-spacing: 0.5px; }
  .menu-item .chips { display: flex; flex-wrap: wrap; gap: 3px; margin-top: 2px; }
  .menu-item .chip {
    font-size: 10px; padding: 2px 6px; border-radius: 10px;
    background: #eee; color: #555; border: 1px solid #ddd;
  }
  .menu-item .price { color: #666; font-size: 11px; float: right; }

  /* Chat area */
  .chat-area { flex: 1; display: flex; flex-direction: column; }
  .chat-header {
    font-size: 12px; font-weight: bold; text-transform: uppercase;
    color: #888; letter-spacing: 1px; padding: 16px 16px 6px;
    border-bottom: 1px solid #eee;
  }
  .messages { flex: 1; padding: 12px 16px; overflow-y: auto; }
  .msg {
    margin-bottom: 10px; padding: 8px 12px; border-radius: 8px;
    font-size: 12px; max-width: 80%; line-height: 1.5;
  }
  .msg.user { background: #e3f2fd; margin-left: auto; text-align: right; }
  .msg.bot { background: #f0f0e8; border: 1px solid #ddd; }
  .msg .label { font-size: 10px; color: #999; margin-bottom: 2px; }

  /* Input */
  .chat-input {
    border-top: 2px solid #333; padding: 12px; display: flex; gap: 8px;
  }
  .chat-input input {
    flex: 1; padding: 8px; border: 1px dashed #999; border-radius: 4px;
    font-family: inherit; font-size: 12px; background: #fafaf5;
  }
  .chat-input button {
    padding: 8px 16px; border: 2px solid #333; background: #333;
    color: #fff; font-family: inherit; font-size: 12px; border-radius: 4px;
    cursor: pointer;
  }
  .chat-input button:disabled { opacity: 0.4; cursor: not-allowed; }

  /* Right panel - formatted order */
  .right-panel {
    width: 260px; border-left: 2px dashed #ccc; padding: 16px;
    flex-shrink: 0; background: #fafaf5;
  }

  /* Order output */
  .order-box {
    border: 2px solid #333; border-radius: 6px; padding: 12px;
    font-size: 11px; line-height: 1.6; background: #fff;
  }
  .order-box .order-title { font-weight: bold; font-size: 13px; margin-bottom: 8px; border-bottom: 1px solid #ddd; padding-bottom: 4px; }
  .order-line { display: flex; justify-content: space-between; }
  .order-line .detail { color: #888; font-size: 10px; padding-left: 12px; }
  .order-opts { padding-left: 12px; font-size: 10px; line-height: 1.8; }
  .order-opts .opt-key { color: #999; }
  .order-opts .opt-val { color: #333; }
  .order-total { border-top: 2px solid #333; margin-top: 8px; padding-top: 6px; font-weight: bold; display: flex; justify-content: space-between; }
  .order-status {
    margin-top: 12px; padding: 6px 8px; background: #333; color: #fff;
    border-radius: 4px; font-size: 11px; text-align: center; font-weight: bold;
    cursor: pointer; border: 2px solid #333; width: 100; font-family: inherit;
  }
  .order-status:hover { background: #555; }
  .order-status.clicked { background: #4caf50; border-color: #4caf50; }

  /* SO display */
  .so-item {
    padding: 8px; margin-bottom: 6px; border: 1px solid #bbb;
    border-radius: 4px; font-size: 12px; background: #fff;
  }
  .so-item .qty { font-weight: bold; }
  .so-item .detail { color: #888; font-size: 11px; margin-top: 2px; }
  .so-id { font-weight: bold; font-size: 13px; margin-bottom: 8px; padding: 6px 8px; background: #e3f2fd; border-radius: 4px; }

  .hidden { display: none; }

  /* Arrows */
  .flow-arrow { text-align: center; color: #888; font-size: 20px; padding: 4px 0; }

  /* Toast */
  .toast {
    position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(80px);
    background: #333; color: #fff; padding: 10px 24px; border-radius: 4px;
    font-family: 'Courier New', monospace; font-size: 12px; font-weight: bold;
    opacity: 0; transition: all 0.3s; z-index: 100; pointer-events: none;
    border: 2px solid #333;
  }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  /* Typing indicator */
  .msg.typing .dots span {
    display: inline-block; width: 6px; height: 6px; border-radius: 50%;
    background: #999; margin: 0 2px; animation: blink 1.2s infinite;
  }
  .msg.typing .dots span:nth-child(2) { animation-delay: 0.2s; }
  .msg.typing .dots span:nth-child(3) { animation-delay: 0.4s; }
  @keyframes blink { 0%, 60%, 100% { opacity: 0.3; } 30% { opacity: 1; } }
</style>
</head>
<body>

<h1>AI Order - Demo Sketch</h1>
<p class="subtitle">WhatsApp Food Ordering Bot &middot; v1 wireframe</p>

<!-- Tabs -->
<div class="tabs">
  <div class="tab active" onclick="showTab('place')">&#x1f4e6; Place Order</div>
  <div class="tab" onclick="showTab('edit')">&#x270f;&#xfe0f; Edit Order</div>
</div>

<!-- TAB 1: Place Order -->
<div class="container" id="tab-place">
  <!-- Left: Menu -->
  <div class="left-panel">
    <div class="panel-title">Menu Items</div>
    <div class="menu-item">
      <span class="price">$4.50</span>
      <div class="name">Brown Sugar Boba</div>
      <div class="options">
        <div class="option-group">
          <div class="option-label">Sugar</div>
          <div class="chips"><span class="chip">0%</span><span class="chip">25%</span><span class="chip">50%</span><span class="chip">75%</span><span class="chip">100%</span></div>
        </div>
        <div class="option-group">
          <div class="option-label">Ice</div>
          <div class="chips"><span class="chip">none</span><span class="chip">less</span><span class="chip">normal</span></div>
        </div>
        <div class="option-group">
          <div class="option-label">Toppings +$0.50</div>
          <div class="chips"><span class="chip">pearl</span><span class="chip">jelly</span><span class="chip">pudding</span></div>
        </div>
      </div>
    </div>
    <div class="menu-item">
      <span class="price">$3.80</span>
      <div class="name">Teh C</div>
      <div class="options">
        <div class="option-group">
          <div class="option-label">Sugar</div>
          <div class="chips"><span class="chip">kosong</span><span class="chip">siu dai</span><span class="chip">normal</span></div>
        </div>
        <div class="option-group">
          <div class="option-label">Temp</div>
          <div class="chips"><span class="chip">hot</span><span class="chip">cold</span></div>
        </div>
      </div>
    </div>
    <div class="menu-item">
      <span class="price">$5.50</span>
      <div class="name">Nasi Lemak</div>
      <div class="options">
        <div class="option-group">
          <div class="option-label">Spice</div>
          <div class="chips"><span class="chip">mild</span><span class="chip">normal</span><span class="chip">extra</span></div>
        </div>
        <div class="option-group">
          <div class="option-label">Add-on +$0.50</div>
          <div class="chips"><span class="chip">egg</span><span class="chip">otah</span><span class="chip">chicken</span></div>
        </div>
      </div>
    </div>
    <div class="menu-item">
      <span class="price">$4.00</span>
      <div class="name">Kopi Gao</div>
      <div class="options">
        <div class="option-group">
          <div class="option-label">Sugar</div>
          <div class="chips"><span class="chip">kosong</span><span class="chip">normal</span><span class="chip">gah dai</span></div>
        </div>
        <div class="option-group">
          <div class="option-label">Temp</div>
          <div class="chips"><span class="chip">hot</span><span class="chip">cold</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Center: Chat -->
  <div class="chat-area">
    <div class="chat-header">Chat</div>
    <div class="messages">
      <div class="msg bot">
        <div class="label">Bot</div>
        Hi! What would you like to order today? You can see our menu on the left.
      </div>
    </div>
    <div class="chat-input">
      <input type="text" placeholder="Type your order in natural language...">
      <button>Send</button>
    </div>
  </div>

  <!-- Right: Formatted Order -->
  <div class="right-panel">
    <div class="panel-title">Order</div>
    <div id="place-order-box" class="order-box" style="color:#888; text-align:center; padding:24px 12px; border-style: dashed;">
      Your order will appear here
    </div>
  </div>
</div>

<!-- TAB 2: Edit Order -->
<div class="container hidden" id="tab-edit">
  <!-- Left: Existing SO -->
  <div class="left-panel">
    <div class="panel-title">Existing Order</div>
    <div class="so-id">SO-2024-0587</div>
    <div class="so-item">
      <span class="qty">1x</span> Brown Sugar Boba
      <div class="detail">50% sugar, no ice, + pearl</div>
    </div>
    <div class="so-item">
      <span class="qty">1x</span> Nasi Lemak
      <div class="detail">extra spicy, + egg</div>
    </div>
    <div class="so-item">
      <span class="qty">2x</span> Teh C
      <div class="detail">siu dai, cold</div>
    </div>
  </div>

  <!-- Center: Chat -->
  <div class="chat-area">
    <div class="chat-header">Chat</div>
    <div class="messages">
      <div class="msg bot">
        <div class="label">Bot</div>
        Hi! I can see your order SO-2024-0587. What would you like to change?
      </div>
    </div>
    <div class="chat-input">
      <input type="text" placeholder="Tell me what to change...">
      <button>Send</button>
    </div>
  </div>

  <!-- Right: Before & After -->
  <div class="right-panel">
    <div class="panel-title">Order</div>
    <div id="edit-order-box" class="order-box">
      <div class="order-title">SO-2024-0587</div>
      <div class="order-line"><span>1x Brown Sugar Boba</span><span>$5.00</span></div>
      <div class="order-opts">
        <div><span class="opt-key">sugar:</span> <span class="opt-val">50%</span></div>
        <div><span class="opt-key">ice:</span> <span class="opt-val">none</span></div>
        <div><span class="opt-key">topping:</span> <span class="opt-val">pearl (+$0.50)</span></div>
      </div>
      <br>
      <div class="order-line"><span>1x Nasi Lemak</span><span>$6.00</span></div>
      <div class="order-opts">
        <div><span class="opt-key">spice:</span> <span class="opt-val">extra</span></div>
        <div><span class="opt-key">add-on:</span> <span class="opt-val">egg (+$0.50)</span></div>
      </div>
      <br>
      <div class="order-line"><span>2x Teh C</span><span>$7.60</span></div>
      <div class="order-opts">
        <div><span class="opt-key">sugar:</span> <span class="opt-val">siu dai</span></div>
        <div><span class="opt-key">temp:</span> <span class="opt-val">cold</span></div>
      </div>
      <div class="order-total"><span>TOTAL</span><span>$18.60</span></div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ── OpenAI config ──
const OPENAI_API_KEY = new URLSearchParams(window.location.hash.slice(1)).get('key') || '';

const SYSTEM_PROMPT = `You are a friendly WhatsApp food ordering bot for a hawker stall.

MENU:
1. Brown Sugar Boba — $4.50
   - sugar: 0%, 25%, 50%, 75%, 100%
   - ice: none, less, normal
   - toppings (+$0.50 each): pearl, jelly, pudding

2. Teh C — $3.80
   - sugar: kosong, siu dai, normal
   - temp: hot, cold

3. Nasi Lemak — $5.50
   - spice: mild, normal, extra
   - add-on (+$0.50 each): egg, otah, chicken

4. Kopi Gao — $4.00
   - sugar: kosong, normal, gah dai
   - temp: hot, cold

RULES:
- Understand Singlish and casual language.
- If the user's order is unclear or missing options, ask for clarification.
- After confirming an order, summarise it clearly with item names, options chosen, and total price.
- Be concise and friendly. Use short replies.
- If the user asks for something not on the menu, politely say it's not available.
- For the Edit Order flow, you are modifying an existing order. Confirm what changed.
- ACCUMULATE ORDERS: In Place Order mode, the order builds up across messages. Always include ALL current items in the "order" JSON. When the user adds items, include previous items plus new ones. When the user removes items, drop them from the list. When the user changes options, update that item.
- COMBINE IDENTICAL ITEMS: If two or more items have the same name AND the same options, combine them into one line with increased qty. Never list the same item+options twice — use qty instead. Example: 2x Brown Sugar Boba (50%, no ice) not two separate 1x lines.

OUTPUT FORMAT:
Always respond with a JSON object. Never respond with plain text.
{
  "message": "Your chat message to the customer",
  "order": null or { "items": [...], "total": number }
}

When "order" is null: you are greeting, asking a clarification question, or no order is ready yet.
When "order" is present, include all items with this structure:
{
  "name": "Item Name",
  "qty": 1,
  "price": 4.50,
  "options": { "sugar": "50%", "ice": "none" },
  "removed": false
}
Set "removed": true for items the customer asked to remove (edit mode).

PRICING — be precise:
- "price" for each item = base price + (number of add-ons/toppings × $0.50), multiplied by qty.
  Example: 1x Nasi Lemak with egg and chicken = $5.50 + $0.50 + $0.50 = $6.50
  Example: 1x Brown Sugar Boba with pearl = $4.50 + $0.50 = $5.00
  Example: 2x Teh C (no add-ons) = $3.80 × 2 = $7.60
- "total" = sum of all non-removed item prices.
Always include "order" when the customer has placed or confirmed items.`;

// Conversation history per tab
const conversationHistory = {
  place: [
    { role: 'system', content: SYSTEM_PROMPT },
    { role: 'assistant', content: "Hi! What would you like to order today? You can see our menu on the left." }
  ],
  edit: [
    { role: 'system', content: SYSTEM_PROMPT + '\n\nYou are now in Edit Order mode. The customer has existing order #0587:\n- 1x Brown Sugar Boba (sugar: 50%, ice: none, topping: pearl)\n- 1x Nasi Lemak (spice: extra, add-on: egg)\n- 2x Teh C (sugar: siu dai, temp: cold)\nTotal: $18.60\n\nHelp them modify this order.' },
    { role: 'assistant', content: "Hi! I can see your order SO-2024-0587. What would you like to change?" }
  ]
};

async function callChatGPT(tabKey, userMessage) {
  conversationHistory[tabKey].push({ role: 'user', content: userMessage });

  const res = await fetch('https://api.openai.com/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${OPENAI_API_KEY}`
    },
    body: JSON.stringify({
      model: 'gpt-4o-mini',
      messages: conversationHistory[tabKey],
      temperature: 0.7,
      max_tokens: 500,
      response_format: { type: 'json_object' }
    })
  });

  if (!res.ok) {
    const err = await res.text();
    throw new Error(`OpenAI API error: ${res.status} — ${err}`);
  }

  const data = await res.json();
  const reply = data.choices[0].message.content;
  conversationHistory[tabKey].push({ role: 'assistant', content: reply });
  return reply;
}

function showTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('tab-place').classList.add('hidden');
  document.getElementById('tab-edit').classList.add('hidden');
  if (tab === 'place') {
    document.querySelectorAll('.tab')[0].classList.add('active');
    document.getElementById('tab-place').classList.remove('hidden');
  } else {
    document.querySelectorAll('.tab')[1].classList.add('active');
    document.getElementById('tab-edit').classList.remove('hidden');
  }
}

// Toast
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 1800);
}

async function sendMessage(container) {
  const input = container.querySelector('.chat-input input');
  const messages = container.querySelector('.messages');
  const text = input.value.trim();
  if (!text) return;

  const tabKey = container.id === 'tab-place' ? 'place' : 'edit';

  const sendBtn = container.querySelector('.chat-input button');
  sendBtn.disabled = true;

  // Add user message
  const userMsg = document.createElement('div');
  userMsg.className = 'msg user';
  userMsg.innerHTML = '<div class="label">You</div>' + text;
  messages.appendChild(userMsg);
  input.value = '';
  messages.scrollTop = messages.scrollHeight;

  // Show typing indicator
  const typing = document.createElement('div');
  typing.className = 'msg bot typing';
  typing.innerHTML = '<div class="dots"><span></span><span></span><span></span></div>';
  messages.appendChild(typing);
  messages.scrollTop = messages.scrollHeight;

  // Call ChatGPT
  try {
    const reply = await callChatGPT(tabKey, text);
    typing.remove();

    let chatText = reply;
    let order = null;
    try {
      const parsed = JSON.parse(reply);
      chatText = parsed.message || reply;
      order = parsed.order || null;
    } catch (e) {}

    const botMsg = document.createElement('div');
    botMsg.className = 'msg bot';
    botMsg.innerHTML = '<div class="label">Bot</div>' + chatText.replace(/\n/g, '<br>');
    messages.appendChild(botMsg);

    if (order) {
      const boxId = tabKey === 'place' ? 'place-order-box' : 'edit-order-box';
      renderOrder(document.getElementById(boxId), order, tabKey);
    }
  } catch (err) {
    typing.remove();
    const errMsg = document.createElement('div');
    errMsg.className = 'msg bot';
    errMsg.innerHTML = '<div class="label">Bot</div>Sorry, something went wrong. ' + err.message;
    messages.appendChild(errMsg);
  }
  sendBtn.disabled = false;
  messages.scrollTop = messages.scrollHeight;
}

function renderOrder(box, order, tabKey) {
  const hasItems = tabKey === 'place'
    ? order.items.some(i => !i.removed)
    : order.items.length > 0;

  if (!hasItems) {
    box.innerHTML = 'Your order will appear here';
    box.style.cssText = 'color:#888; text-align:center; padding:24px 12px; border-style: dashed;';
    const btn = box.parentElement.querySelector('.order-status');
    if (btn) btn.remove();
    return;
  }

  const orderNum = tabKey === 'edit' ? 'SO-2024-0587 (edited)' : 'Order #' + String(Math.floor(1000 + Math.random() * 9000));
  let html = `<div class="order-title">${orderNum}</div>`;

  const visibleItems = tabKey === 'place' ? order.items.filter(i => !i.removed) : order.items;

  visibleItems.forEach((item, idx) => {
    const strikeStyle = item.removed ? ' style="text-decoration: line-through; color: #999;"' : '';
    html += `<div class="order-line"${strikeStyle}><span>${item.qty}x ${item.name}</span><span>$${item.price.toFixed(2)}</span></div>`;

    if (item.options && !item.removed) {
      html += '<div class="order-opts">';
      for (const [key, val] of Object.entries(item.options)) {
        html += `<div><span class="opt-key">${key}:</span> <span class="opt-val">${val}</span></div>`;
      }
      html += '</div>';
    }
    if (idx < visibleItems.length - 1) html += '<br>';
  });

  const computedTotal = order.items
    .filter(i => !i.removed)
    .reduce((sum, i) => sum + i.price, 0);
  html += `<div class="order-total"><span>TOTAL</span><span>$${computedTotal.toFixed(2)}</span></div>`;
  box.innerHTML = html;
  box.style = '';

  // Add submit button
  let submitBtn = box.parentElement.querySelector('.order-status');
  if (!submitBtn) {
    submitBtn = document.createElement('button');
    submitBtn.className = 'order-status';
    submitBtn.textContent = tabKey === 'edit' ? 'Edit Order' : 'Create Order';
    box.parentElement.appendChild(submitBtn);
    submitBtn.addEventListener('click', () => {
      const label = submitBtn.textContent;
      submitBtn.classList.add('clicked');
      submitBtn.textContent = 'Sent!';
      showToast('Order submitted successfully');
      setTimeout(() => { submitBtn.classList.remove('clicked'); submitBtn.textContent = label; }, 2000);
    });
  }
}

// Send button clicks
document.querySelectorAll('.chat-input button').forEach(btn => {
  btn.addEventListener('click', () => sendMessage(btn.closest('.container')));
});

// Enter key
document.querySelectorAll('.chat-input input').forEach(input => {
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter') sendMessage(input.closest('.container'));
  });
});
</script>

</body>
</html>
